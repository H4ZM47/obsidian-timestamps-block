# Obsidian Plugin Development Skill

Use this skill when asked to create, modify, or debug Obsidian plugins. This guide provides comprehensive instructions for building cross-platform (desktop + mobile) Obsidian plugins using TypeScript.

---

## Quick Reference

### Project Structure
```
plugin-name/
├── src/
│   ├── main.ts              # Plugin entry point (exports default class)
│   ├── settings.ts          # Settings interface and PluginSettingTab
│   └── types.ts             # TypeScript interfaces
├── styles.css               # Optional CSS styles
├── manifest.json            # Plugin metadata (REQUIRED)
├── package.json             # NPM dependencies
├── tsconfig.json            # TypeScript config
├── esbuild.config.mjs       # Build config
└── .gitignore
```

### Essential Files

**manifest.json** (REQUIRED)
```json
{
  "id": "plugin-id",
  "name": "Plugin Display Name",
  "version": "1.0.0",
  "minAppVersion": "0.15.0",
  "description": "Brief description",
  "author": "Author Name",
  "isDesktopOnly": false
}
```

**package.json**
```json
{
  "name": "plugin-id",
  "version": "1.0.0",
  "main": "main.js",
  "scripts": {
    "dev": "node esbuild.config.mjs",
    "build": "tsc -noEmit -skipLibCheck && node esbuild.config.mjs production"
  },
  "devDependencies": {
    "@types/node": "^16.11.6",
    "builtin-modules": "^3.3.0",
    "esbuild": "0.17.3",
    "obsidian": "latest",
    "tslib": "2.4.0",
    "typescript": "4.7.4"
  }
}
```

**tsconfig.json**
```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "inlineSourceMap": true,
    "inlineSources": true,
    "module": "ESNext",
    "target": "ES6",
    "allowJs": true,
    "noImplicitAny": true,
    "moduleResolution": "node",
    "importHelpers": true,
    "isolatedModules": true,
    "strictNullChecks": true,
    "lib": ["DOM", "ES5", "ES6", "ES7"]
  },
  "include": ["**/*.ts"]
}
```

**esbuild.config.mjs**
```javascript
import esbuild from "esbuild";
import process from "process";
import builtins from "builtin-modules";

const banner = `/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
*/
`;

const prod = process.argv[2] === "production";

const context = await esbuild.context({
  banner: { js: banner },
  entryPoints: ["src/main.ts"],
  bundle: true,
  external: [
    "obsidian",
    "electron",
    "@codemirror/autocomplete",
    "@codemirror/collab",
    "@codemirror/commands",
    "@codemirror/language",
    "@codemirror/lint",
    "@codemirror/search",
    "@codemirror/state",
    "@codemirror/view",
    "@lezer/common",
    "@lezer/highlight",
    "@lezer/lr",
    ...builtins,
  ],
  format: "cjs",
  target: "es2018",
  logLevel: "info",
  sourcemap: prod ? false : "inline",
  treeShaking: true,
  outfile: "main.js",
});

if (prod) {
  await context.rebuild();
  process.exit(0);
} else {
  await context.watch();
}
```

**.gitignore**
```
node_modules/
main.js
*.js.map
.npm/
data.json
```

---

## Plugin Class Structure

### Basic Plugin Template
```typescript
import { App, Plugin, PluginSettingTab, Setting, Notice, MarkdownView, Editor } from 'obsidian';

// Settings interface
interface MyPluginSettings {
  settingOne: string;
  settingTwo: boolean;
  settingThree: number;
}

// Default settings
const DEFAULT_SETTINGS: MyPluginSettings = {
  settingOne: 'default value',
  settingTwo: true,
  settingThree: 42
};

// Main plugin class
export default class MyPlugin extends Plugin {
  settings: MyPluginSettings;

  async onload() {
    console.log('Loading plugin');

    // 1. Load settings
    await this.loadSettings();

    // 2. Register commands
    this.addCommand({
      id: 'my-command',
      name: 'My Command',
      callback: () => {
        new Notice('Command executed!');
      }
    });

    // 3. Add settings tab
    this.addSettingTab(new MyPluginSettingTab(this.app, this));

    // 4. Register events (auto-cleanup on unload)
    this.registerEvent(
      this.app.workspace.on('file-open', (file) => {
        if (file) console.log('Opened:', file.path);
      })
    );
  }

  onunload() {
    console.log('Unloading plugin');
  }

  async loadSettings() {
    this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
  }

  async saveSettings() {
    await this.saveData(this.settings);
  }
}

// Settings tab
class MyPluginSettingTab extends PluginSettingTab {
  plugin: MyPlugin;

  constructor(app: App, plugin: MyPlugin) {
    super(app, plugin);
    this.plugin = plugin;
  }

  display(): void {
    const { containerEl } = this;
    containerEl.empty();

    containerEl.createEl('h2', { text: 'Plugin Settings' });

    new Setting(containerEl)
      .setName('Setting One')
      .setDesc('Description of setting one')
      .addText(text => text
        .setPlaceholder('Enter value')
        .setValue(this.plugin.settings.settingOne)
        .onChange(async (value) => {
          this.plugin.settings.settingOne = value;
          await this.plugin.saveSettings();
        }));

    new Setting(containerEl)
      .setName('Setting Two')
      .setDesc('Description of setting two')
      .addToggle(toggle => toggle
        .setValue(this.plugin.settings.settingTwo)
        .onChange(async (value) => {
          this.plugin.settings.settingTwo = value;
          await this.plugin.saveSettings();
        }));

    new Setting(containerEl)
      .setName('Setting Three')
      .setDesc('Description of setting three')
      .addSlider(slider => slider
        .setLimits(0, 100, 1)
        .setValue(this.plugin.settings.settingThree)
        .setDynamicTooltip()
        .onChange(async (value) => {
          this.plugin.settings.settingThree = value;
          await this.plugin.saveSettings();
        }));
  }
}
```

---

## Commands

### Command Types

**Basic Command**
```typescript
this.addCommand({
  id: 'command-id',
  name: 'Human Readable Name',
  callback: () => {
    // Action without editor access
  }
});
```

**Editor Command** (only shows when editor is active)
```typescript
this.addCommand({
  id: 'editor-command',
  name: 'Editor Command',
  editorCallback: (editor: Editor, view: MarkdownView) => {
    const selection = editor.getSelection();
    editor.replaceSelection(`**${selection}**`);
  }
});
```

**Conditional Command**
```typescript
this.addCommand({
  id: 'conditional-command',
  name: 'Conditional Command',
  checkCallback: (checking: boolean) => {
    const condition = /* your logic */;
    if (checking) return condition;
    if (condition) {
      // Execute action
    }
  }
});
```

**Editor Check Command** (conditional + editor)
```typescript
this.addCommand({
  id: 'editor-check-command',
  name: 'Editor Check Command',
  editorCheckCallback: (checking: boolean, editor: Editor, view: MarkdownView) => {
    const hasSelection = editor.getSelection().length > 0;
    if (checking) return hasSelection;
    if (hasSelection) {
      // Execute action
    }
  }
});
```

---

## Editor API

### Getting the Active Editor
```typescript
const view = this.app.workspace.getActiveViewOfType(MarkdownView);
if (view) {
  const editor = view.editor;
  // Use editor methods
}
```

### Common Editor Operations

```typescript
// Get cursor position
const cursor = editor.getCursor();  // { line: number, ch: number }

// Get selection
const selection = editor.getSelection();

// Replace selection
editor.replaceSelection('new text');

// Insert at position
editor.replaceRange('text', { line: 0, ch: 0 });

// Replace range
editor.replaceRange('new', { line: 0, ch: 0 }, { line: 0, ch: 3 });

// Get line text
const lineText = editor.getLine(lineNumber);

// Set line text
editor.setLine(lineNumber, 'new line text');

// Get entire document
const content = editor.getValue();

// Set entire document
editor.setValue('new content');

// Set cursor position
editor.setCursor({ line: 5, ch: 10 });

// Set selection
editor.setSelection(
  { line: 0, ch: 0 },  // anchor
  { line: 0, ch: 10 }  // head
);

// Get line count
const lineCount = editor.lineCount();

// Scroll to line
editor.scrollIntoView({ from: { line: 10, ch: 0 }, to: { line: 10, ch: 0 } });
```

### Insert Timestamp Example
```typescript
editorCallback: (editor: Editor) => {
  const timestamp = window.moment().format('YYYY-MM-DD HH:mm');
  const cursor = editor.getCursor();
  editor.replaceRange(`[${timestamp}] `, cursor);
}
```

---

## Settings UI Components

### Text Input
```typescript
new Setting(containerEl)
  .setName('Name')
  .setDesc('Description')
  .addText(text => text
    .setPlaceholder('Placeholder')
    .setValue(this.plugin.settings.value)
    .onChange(async (value) => {
      this.plugin.settings.value = value;
      await this.plugin.saveSettings();
    }));
```

### Text Area
```typescript
new Setting(containerEl)
  .setName('Name')
  .addTextArea(text => text
    .setPlaceholder('Placeholder')
    .setValue(this.plugin.settings.value)
    .onChange(async (value) => {
      this.plugin.settings.value = value;
      await this.plugin.saveSettings();
    }));
```

### Toggle
```typescript
new Setting(containerEl)
  .setName('Name')
  .addToggle(toggle => toggle
    .setValue(this.plugin.settings.enabled)
    .onChange(async (value) => {
      this.plugin.settings.enabled = value;
      await this.plugin.saveSettings();
    }));
```

### Dropdown
```typescript
new Setting(containerEl)
  .setName('Name')
  .addDropdown(dropdown => dropdown
    .addOption('option1', 'Option 1')
    .addOption('option2', 'Option 2')
    .setValue(this.plugin.settings.choice)
    .onChange(async (value) => {
      this.plugin.settings.choice = value;
      await this.plugin.saveSettings();
    }));
```

### Slider
```typescript
new Setting(containerEl)
  .setName('Name')
  .addSlider(slider => slider
    .setLimits(0, 100, 5)
    .setValue(this.plugin.settings.number)
    .setDynamicTooltip()
    .onChange(async (value) => {
      this.plugin.settings.number = value;
      await this.plugin.saveSettings();
    }));
```

### Button
```typescript
new Setting(containerEl)
  .setName('Name')
  .addButton(button => button
    .setButtonText('Click Me')
    .onClick(async () => {
      // Action
    }));
```

---

## Mobile Compatibility

### Critical Rules

1. **Set `isDesktopOnly: false`** in manifest.json
2. **NEVER use Node.js APIs** (`fs`, `path`, `child_process`, etc.)
3. **NEVER use Electron APIs**
4. **NEVER use regex lookbehind** (breaks iOS Safari)

### Platform Detection
```typescript
import { Platform } from 'obsidian';

if (Platform.isMobile) {
  // Mobile-specific code
}

if (Platform.isDesktop) {
  // Desktop-specific code
}

if (Platform.isIosApp) {
  // iOS-specific code
}

if (Platform.isAndroidApp) {
  // Android-specific code
}
```

### iOS Regex Compatibility

```typescript
// BAD - crashes on iOS
const regex = /(?<=@)\w+/;

// GOOD - iOS compatible
const regex = /@(\w+)/;
const match = text.match(regex);
const result = match ? match[1] : null;
```

### Testing Mobile
```javascript
// In Obsidian Developer Console
this.app.emulateMobile(true);   // Enable mobile emulation
this.app.emulateMobile(false);  // Disable
this.app.isMobile;              // Check current state
```

---

## Common Patterns

### Working with Files

```typescript
// Get active file
const activeFile = this.app.workspace.getActiveFile();

// Read file content
const content = await this.app.vault.read(file);

// Modify file
await this.app.vault.modify(file, newContent);

// Create file
await this.app.vault.create('path/to/file.md', content);

// Delete file
await this.app.vault.delete(file);

// Get all markdown files
const files = this.app.vault.getMarkdownFiles();
```

### Event Registration

```typescript
// File events
this.registerEvent(
  this.app.vault.on('create', (file) => { /* ... */ })
);
this.registerEvent(
  this.app.vault.on('modify', (file) => { /* ... */ })
);
this.registerEvent(
  this.app.vault.on('delete', (file) => { /* ... */ })
);

// Workspace events
this.registerEvent(
  this.app.workspace.on('file-open', (file) => { /* ... */ })
);
this.registerEvent(
  this.app.workspace.on('active-leaf-change', (leaf) => { /* ... */ })
);

// Editor events
this.registerEvent(
  this.app.workspace.on('editor-change', (editor) => { /* ... */ })
);
```

### DOM Events
```typescript
this.registerDomEvent(document, 'keydown', (evt: KeyboardEvent) => {
  if (evt.key === 'Enter' && evt.ctrlKey) {
    // Handle Ctrl+Enter
  }
});
```

### Intervals
```typescript
// Auto-cleaned up on plugin unload
this.registerInterval(
  window.setInterval(() => {
    // Periodic task
  }, 5 * 60 * 1000)  // Every 5 minutes
);
```

### Notices (Toast Messages)
```typescript
import { Notice } from 'obsidian';

new Notice('Simple message');
new Notice('Message with duration', 5000);  // 5 seconds
```

### Modals
```typescript
import { App, Modal } from 'obsidian';

class MyModal extends Modal {
  constructor(app: App) {
    super(app);
  }

  onOpen() {
    const { contentEl } = this;
    contentEl.setText('Modal content');
  }

  onClose() {
    const { contentEl } = this;
    contentEl.empty();
  }
}

// Usage
new MyModal(this.app).open();
```

---

## Using moment.js

Obsidian includes moment.js globally:

```typescript
// Current time formatted
const timestamp = window.moment().format('YYYY-MM-DD HH:mm:ss');

// Custom format
const date = window.moment().format('dddd, MMMM D, YYYY');

// Relative time
const relative = window.moment('2024-01-01').fromNow();

// Parse date
const parsed = window.moment('2024-01-15', 'YYYY-MM-DD');
```

### Common Format Tokens
| Token | Output |
|-------|--------|
| YYYY | 2024 |
| MM | 01-12 |
| DD | 01-31 |
| HH | 00-23 |
| mm | 00-59 |
| ss | 00-59 |
| ddd | Mon, Tue... |
| dddd | Monday, Tuesday... |
| MMM | Jan, Feb... |
| MMMM | January, February... |

---

## Debugging

### Console Logging
```typescript
console.log('Debug message');
console.warn('Warning');
console.error('Error');
```

### Developer Tools
- **Desktop**: Ctrl/Cmd + Shift + I
- **Mobile**: Connect via remote debugging

### Common Issues

1. **Plugin not loading**: Check manifest.json syntax
2. **Settings not saving**: Ensure `await this.saveSettings()`
3. **Mobile crash**: Look for Node.js/Electron API usage
4. **iOS crash**: Check for regex lookbehind

---

## Publishing Checklist

- [ ] `manifest.json` has correct `id`, `name`, `version`
- [ ] `isDesktopOnly` is correctly set
- [ ] No Node.js/Electron APIs (if mobile support)
- [ ] No regex lookbehind (if iOS support)
- [ ] README.md with usage instructions
- [ ] LICENSE file included
- [ ] Tested on desktop
- [ ] Tested on mobile (emulation or device)
- [ ] No console errors
- [ ] Settings persist across restarts

---

## Resources

- [Obsidian Sample Plugin](https://github.com/obsidianmd/obsidian-sample-plugin)
- [Obsidian API Definitions](https://github.com/obsidianmd/obsidian-api)
- [Official Developer Docs](https://docs.obsidian.md/Plugins/Getting+started/Build+a+plugin)
- [Unofficial Plugin Docs](https://marcus.se.net/obsidian-plugin-docs/)
